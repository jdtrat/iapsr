---
title: "IAPS Choice Task Analysis"
author: "Jonathan Trattner, Rachel Jones, and Delaney Teceno"
date: "Last compiled on `r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    fig.width: 7
    fig.asp: 0.718
    df_print: paged
    toc: true
    toc_depth: 4
    toc_float:
      collapsed: true
      smooth_scroll: true
    theme: journal
    highlight: monochrome
    code_folding: hide
params:
  numSubjects: 5
---

```{r setup, include = FALSE}
#Load packages
library(tidyverse)
library(tidymodels)
library(fs)
library(tictoc)
library(vip)
library(caret)
library(iapsr) #our package, woohoo!

myGGTheme <- ggplot2::theme(plot.title = ggplot2::element_text(hjust=0.5, face = "bold.italic", size=16), #plot title aesthetics
                   plot.subtitle = ggplot2::element_text(hjust = 0.5, face = "bold", size = 12), #plot subtitle aesthetics
                   axis.title.x = ggplot2::element_text(size = 12, color= "black", face = "bold"), #x axis title aesthetics
                   axis.title.y = ggplot2::element_text(size = 12, color= "black", face = "bold"), #y axis title aesthetics
                   axis.text.x = ggplot2::element_text(angle = 0, hjust = 0.5, size = 12),
                   #legend aesthetics
                   legend.title = ggplot2::element_text(size= 14,
                                    color = "black",
                                    face = "bold"),
                   legend.title.align = 0.5,
                   legend.text = ggplot2::element_text(size = 10,
                                              color = "black",
                                              face = "bold"),
                   legend.text.align = 0)
```

## Introduction

Background on choice task ! Woohoo! Thanks *Rachel* for being so **awesome!**

### Read in the Data

Below, we read in the data and preview the raw text file output from the choice task.

```{r read in data, cols.print = 2, message = FALSE, warning = FALSE}

choiceFiles <- dir_ls('~/Desktop/IAPS/RJT/choice/', glob = "*.txt.txt") #get the paths for the files that contain the string ".txt.txt". For new cohort.

rawChoiceData <- map(choiceFiles, ~readChoices(.x), .id = "subject")

#preview raw choice data
head(as.data.frame(rawChoiceData[[1]]), 20)

```

### Tidy the Data

Below, we tidy the data using the `iapsr` function `processChoiceData` and preview it. For information on how the processing was done, call `?iapsr::processChoiceData()` in the console. In summary, for each subject this function returns a dataframe 150 rows and 13 columns:

* phase: The phase the choices were made in.

* round: The round number these choices were made in, specific to the phase.

* runningRound: The round number these choices were made in (1-150), independent of phase. This is useful for plotting the percent of optimal choices over time.

* icon1: The icon presented in the first order position.

* rank1: The rank of icon1. The higher this is, the higher the expected utility of choosing icon1.

* icon2: The icon presented in the second order position.

* rank2: The rank of icon2. The higher this is, the higher the expected utility of choosing icon2.

* option: The option the subject chose. This should correspond to the icon order as presented in the task.

* choice: The icon the subject chose.

* group: The (payment weighting) group the chosen icon corresponds to.

* image: The image the subject was shown after making a choice.

* optimal: A binary variable tracking whether or not the choice was optimal. This is 1 if the rank of the icon chosen is higher than the rank of the one not chosen. It is 0 otherwise. The ranks are based on the expected utility for each icon. See getGroupInfo for that information.

* percentOptimal: The cumulative sum of optimal choices divided by the total round (1-150).

```{r tidy data, cols.print = 7}

finalChoiceData <- map_df(rawChoiceData, ~processChoiceData(.x), .id = "subject") %>%
  mutate(subject = str_extract(subject, "[:graph:]{9}(?=choice.txt)"))

finalChoiceData %>%
  head(10)
```

## Analyze Optimal Choices

Each subject is presented with a choice between two icons. In phase 1 there are three icons all leading to positively valenced images with varying probabilities. In phase 2 and 3 there are six icons; three lead to positively valenced images and three lead to negatively valenced images with differing probabilities. For instance, icon 1 might offer a reward equivalent to \$1.00 in valence with probability 0.25 and icon 2 might offer a reward equivalent to \$1.00 in valence with probability 0.5. Thus, the expected utility of icon 2 is greater than the expected utility of icon 1. This means that whenever an individual is presented with these two icons, the optimal choice is to choose icon 2.

Using the `getGroupInfo` function from the `iapsr` package, we get the reward-probability mappings for each icon per subject and then plot the cumulative sum of optimal choices. 

### Percent Optimal Plot

Below are two plots created using the `iapsr` function `plotPercentOptimal`. They show the percent of optimal choices taken by each of the `r params$numSubjects` subjects over the entire task. Phases are indicated. The second plot is faceted by subject.

```{r plot the data - combined, fig.align = "center", out.width = "90%"}

finalChoiceData %>% plotPercentOptimal(facet = FALSE)

```

```{r plot the data - faceted, fig.align = "center", out.width = "90%"}

finalChoiceData %>% plotPercentOptimal(facet = TRUE)

```
