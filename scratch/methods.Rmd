---
title: "IAPS Methods"
author: "Jonathan Trattner, Rachel Jones, and Delaney Teceno"
date: "Last compiled on `r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    df_print: paged
    toc: true
    toc_depth: 4
    toc_float:
      collapsed: true
      smooth_scroll: true
    theme: journal
    highlight: monochrome
    code_folding: hide
params:
  numSubjects: 6
---
```{r load packages, include = FALSE, warnings = FALSE}
#Load Packages
library(tidyverse)
library(tidymodels)
library(caret)
library(fs)
library(vip)
library(janitor)
library(dplyr)
library(xtable)
library(knitr)
library(kableExtra)
library(iapsr) #our package, woohoo!
library(patchwork)
library(flextable)
library(magick)
library(webshot2)
```


## Participants and Procedure

24 healthy volunteers (18 females and 6 males) between ages 18 and 64 were recruited for this study at the Piedmont Triad Research Community Center. We conducted an a priori power analysis using a power value of no lower than 80% for a linear regression with an α value of 0.05. We used the R package `pwr` to calculate the minimal sample size for general linear model. This suggested 20 participants would ensure 80% statistical power. All subjects were screened 24 hours in advance, and minutes before, scheduled appointments to ensure no COVID-19 symptomology. The average age of participants was “X” years old (SD = x, range = x). The study was approved by the institutional review board of Wake Forest University School of Medicine. 

## Task Description

This task consisted of two components: a passive choice game followed by image ratings. The choice game was a 150-trial two-choice probabilistic reward task with emotionally-stimulating images from the IAPS database used as reinforcers. Each trial began with presentation of two icons on a computer screen, and participants were required to choose between them using a Logitech gaming controller. A total of 58 icons were randomly selected to be in one of six groups, with six unique icons per group (Table 1). Within each group, icons held fixed probabilities of displaying positive, neutral, or negative images as outcomes. The game was divided into three phases that the icon groups corresponded to, with 25 trails in phase one, 50 trails in phase 2, and 75 trials in phase 3 (Table 2). 

Phase one held positive-only icons, where fixed probabilities of showing positive images were pre-determined per icon (i.e. 25%, 50%, and 75% vs neutral). Phase two introduced negative-only icons with similar fixed probabilities of showing negative images per icon. In these phases, each round showed pairs of positive icons or pairs of negative icons exclusively. However, in phase 3, all icons were mixed so that any round may have consisted of two positive icons, two negative icons, or one positive and one negative icon. In this phase, outcome magnitudes changed giving rise to higher-complexity positive and negative images. That is, our selected positive and negative images were not equidistant from zero, but rather varied in complexity according to phase number. The probabilities associated with each icon remained the same throughout the game, meaning the expected value of each option is altered by phase 3. We employed this phase transition to understand temporal learning effects from images that vary in reward and complexity. The IAPS images used are presented in Appendix A according to valence, dominance, and arousal. 

```{r table 1, include = TRUE}
IAPSgroups1 <- read_csv('C:/Users/rachjone/Desktop/IAPS/Tables/IAPSgroups.csv')

flex <- flextable(head(IAPSgroups1)) %>%
set_header_labels(Group = "Group", Probabilities = "Probabilities") %>%
theme_vanilla() %>%
align(align = "center", part = "all") %>%
bg(bg = "cyan3", part = "header") %>%
bg(bg = "snow3", part = "body") %>%
color(color = "black", part = "all") %>%
bold(bold = TRUE, part = "header") %>%
fontsize(size = 14, part = "all") %>%
set_caption("Table 1: Icon Groupings") %>%
autofit()

plot(flex)
```



```{r table 2, include = TRUE}
IAPSphases1 <- read_csv('C:/Users/rachjone/Desktop/IAPS/Tables/IAPSphases.csv')

flex1 <- flextable(head(IAPSphases1)) %>%
  set_header_labels(Phase = "Phase", Trials = "Trials", Associated.Groups = "Associated Groups", Description = "Description") %>%
  theme_vanilla() %>%
  align(align = "center", part = "all") %>%
  bg(bg = "coral2", part = "header") %>%
  bg(bg = "snow3", part = "body") %>%
  color(color = "black", part = "all") %>%
  bold(bold = TRUE, part = "header") %>%
  fontsize(size = 14, part = "all") %>%
  set_caption("Table 2: Description of Phases in IAPS Choice Game") %>%
  autofit()

plot(flex1)
```

  
Participants were instructed to select their preferred icon and told that different types of images would be presented dependent upon their choice (Figure 1). They were not given instructions on the relationship between icons and images or the goal of the experiment. Before and after the game, participants were asked to select one of two icons they prefer with no image outcome. This was important to determine if certain characteristics of icons (i.e. color, laterality) influenced participants' choices throughout the game or if this changed because of image outcome.

  
After the passive choice game, participants rated all 121 images in response to the question of how positive and negative each image made them feel. The answers ranged from ‘not at all’ to ‘very much’ whereby their answers were constrained along specific parametric dimensions. Participants used the same Logitech controller used during the choice game to rate these images. 

## Statistical Analyses 

### Choice game 

The percent of optimal choices for this cohort was plotted with respect to trial number over all phases of the choice game. 

### Rating Task

Using both the `tidymodels` framework in R and the `caret` package in R, we tuned an elastic net regression with a wide array of alpha (0 to 1) and lambda (0 to 200) values using six-fold and ten-fold cross validation. Our goal was to determine the best model for predicting the mean valence, arousal, and dominance ratings (from the IAPS standardized IAPS data set) using subjects' positive and negative image ratings (and the interaction between them), age, and gender. We trained our model on data collected from participants in 2018 (n = 47) and tested it on the most recent 24 subjects. Model fit was evaluated with the root mean squared error (rmse), mean absolute error (mae), and the R2 metrics. These indicated that a regular linear regression performed best. We used both the `caret` package to perform 10-fold cross validation on the training data, and the `lm` function in R fit on the entire training dataset. The linear models performed equally well independent of cross validation. It should also be noted that we tested the linear model without the interaction between positive and negative ratings and it performed worse on all metrics. Included are code snippets for performing linear regressions using `lm` and `caret`. Elastic net regression code and model coefficients are available upon request.

To determine the accuracy of our model, we compared actual and predicted outcomes. Actual outcomes were defined by standardized scores of valence, arousal, and dominance from the IAPS database while predicted outcomes were defined by our linear regression results. The predicted and actual ratings had an overall correlation of 0.801 for valence, 0.743 for dominance, and 0.484 for arousal. 


Knitr Table Code to display cohort demographics (work in progress)

```{r setup, include=FALSE}

dirIAPS <- '~/Desktop/IAPS/IAPSdata/' #set the directory for IAPS data
dirData <- '~/Desktop/IAPS/Subject Data/' #set the directory for subject data
dirImageOrder <- '~/Desktop/IAPS/Subject Image Order/' #set the directory for image order
dirRatings <- '~/Desktop/IAPS/RJT/ratings/' #for new cohort
fileRatings <- dir_ls(dirRatings, glob = "*.txt.txt") #get the paths for the files that contain the string ".txt.txt". For new cohort.
filesIAPS <- dir_ls(dirIAPS) #list the files in the IAPS directory
filesData <- dir_ls(dirData) #list the files in the subject data directory
filesImageOrder <- dir_ls(dirImageOrder) #list the files in the image order directory

#Import the IAPS key data set
keyIAPS <- filesIAPS %>%
  map_df(~read_csv(.x, na = c("", ".", NA),
                   col_types = cols(IAPS = col_character())) %>%
           select(desc:dom1sd) %>%
           drop_na(),
         .id = "form") %>%
  mutate(form = case_when(str_detect(form, "1_IAPS") ~ 1,
                          str_detect(form, "2_IAPS") ~ 2,
                          str_detect(form, "3_IAPS") ~ 3,
                          str_detect(form, "4_IAPS") ~ 4),
         form = as.factor(form))

#Read in subject rating
subjectData <- filesData %>%
  map_df(~read_csv(.x) %>%
           rename(time = Timestamp,
                  subject = `Subject ID:`),
         .id = "form") %>%
  mutate(form = case_when(str_detect(form, "1_SFA") ~ 1,
                          str_detect(form, "2_SFA") ~ 2,
                          str_detect(form, "3_SFA") ~ 3,
                          str_detect(form, "4_SFA") ~ 4),
           form = as.factor(form)) %>%
  #pivot the data so all ratings are in a column "rating" instead of in their own rows.
  pivot_longer(cols = -c(form, time, subject), values_to = "rating") %>%
  select(-name) %>%
  #have a running order for each subject
  group_by(subject) %>%
  mutate(order = row_number()) %>%
  ungroup() %>%
  #make this subjectID string match that of imageOrder
  mutate(subject = str_replace(subject, "\\-", "\\_")) %>%
  select(-time) %>%
  #arrange by each subject and the form (so one subject goes through all four
  #forms before moving to next subject)
  arrange(subject, form)


  imageOrder <- filesImageOrder %>%
  map_df(~read_csv(.x),
         .id = "form") %>%
  mutate(form = case_when(str_detect(form, "1_pictureID") ~ 1,
                          str_detect(form, "2_pictureID") ~ 2,
                          str_detect(form, "3_pictureID") ~ 3,
                          str_detect(form, "4_pictureID") ~ 4),
         form = as.factor(form)) %>%
  #pivot the data so all image values (IDs) are in a column "value"
  pivot_longer(cols = -c(X1, form),
               names_to = "subject") %>%
  #remvoe subject prefix
  mutate(subject = str_remove(.$subject, "\\d\\_")) %>%
  #arrange by subject
  arrange(subject) %>%
  #remove NAs that appear because of how the data was read in where each form's
  #image ID were basically in a new column for the subject with the prefix
  #1_SFA_..."
  drop_na() %>%
  #have a running order for each subject, and remove the X1 column.
  group_by(subject) %>%
  mutate(order = row_number()) %>%
  ungroup() %>%
  select(-X1)

#read in demographics
demographics <- read_csv(file = 'C:/Users/rachjone/Desktop/IAPS/Demographics/KLRIF_2018-07-09.csv')
  
#tidy the demographics data
tidyDems <- demographics %>%
  rename(subject = "Subject ID", 
         age = "Age (years)",
         gender = "What is your gender?") %>%
  mutate(subject = str_replace(subject, "\\-", "\\_"),
         gender = recode(gender, "Male" = 1, "Female" = 0)) %>%
  select(subject, age, gender)


#join the imageOrder and subject data by subject, form, and order.
orderedSubjectData <- full_join(imageOrder, subjectData, by = c("form", "subject", "order")) %>%
  rename(picID = value)

labeledOrderedSubjectData <- orderedSubjectData %>%
  mutate(question = case_when(str_detect(picID, "P") ~ "positive",
                              str_detect(picID, "N") ~ "negative",
                              TRUE ~ "Oops"),
         picID = str_remove_all(picID, "P|N")) %>%
  rename(IAPS = picID)

positiveRatings <- labeledOrderedSubjectData %>%
  filter(question == "positive") %>%
  pivot_wider(names_from = question, values_from = rating)

negativeRatings <- labeledOrderedSubjectData %>%
  filter(question == "negative") %>%
  pivot_wider(names_from = question, values_from = rating)
```



```{r read data, message=FALSE, warning=FALSE}

#Read raw demographic data that includes 84 subjects. 
Dems <-read_csv(file = 'C:/Users/rachjone/Desktop/IAPS/SFA_demographics.csv')

#Tidy the data and filter to only display demographic variables of interest (age, gender, race, ethnicity, history of psychiatric condition and medications, and current drug, alcohol, and smoking use.)
tidyDems2 <- Dems %>%
    clean_names %>% 
    select(participant_id, gender, race_1:race_6, age, psychiatric_condition, condition_description, smoke_current, alcohol_current, drugs_current, current_use_description) %>%
  pivot_longer(cols = c(race_1:race_6), values_to = "race") %>%
  rename(subject = participant_id) %>%
  mutate(name = recode(name, race_1 = "Asian", race_2 = "NHPI", race_3 = "AIAN", race_4 = "Black", race_5 = "White", race_6 = "Other"),
  gender = recode(gender, "1" = "0", "2" = "1"),
  current_use_description = recode(current_use_description, "marijuana" = "Marijuana"),
  subject = str_replace(subject, "\\-", "\\_")) %>%
  filter(race == "1" | subject == "SFA_1034" | subject == "SFA_1039" | subject == "SFA_1049" | subject == "SFA_1071") %>%
  distinct (subject, race, .keep_all = TRUE)

#Join table with the 47 subjects we used for our analyses. This gets rid of extra subjects we did not include for the old cohort (There were 84 total, and we only used 47 in our analyse). 
finalData <- full_join(positiveRatings, negativeRatings, by = c("IAPS", "subject", "form")) %>%
  select(-c(order.x, order.y)) %>%
  full_join(keyIAPS, by = c("IAPS", "form")) %>%
  full_join(tidyDems, by = "subject") %>%
  drop_na() %>%
  select(subject, age, gender, 
         form, IAPS, desc, 
         positive, negative, everything())

finalData2 <- finalData %>%
 select(-c(age:dom1sd)) %>%
 distinct()

DemJoin <- right_join(tidyDems2, finalData2, by = "subject")

DemJoin$gender <- as.numeric(DemJoin$gender)
DemJoin$smoke_current <- as.numeric(DemJoin$smoke_current)
DemJoin$alcohol_current <- as.numeric(DemJoin$alcohol_current)
DemJoin$drugs_current <- as.numeric(DemJoin$drugs_current)


```

```{r output table, echo = FALSE, results = 'asis'}

#Create output table. 
dem.tab <- DemJoin %>%
mutate(name=ifelse(race == "0",NA,name),
  condition_description = recode(condition_description, "Generalized Anxiety Disorder" = "Anxiety", "depression, anxiety, eating disorder" = "Depression & Anxiety", "Depression, Bulimia Nervosa" = "Depression &  Bulimia Nervosa")) %>%
  select(-race) %>%
  rename(race = name) 

head(dem.tab)

```



```{r asdf, warning = FALSE}

myGGTheme <- ggplot2::theme(plot.title = ggplot2::element_text(hjust=0.5, face = "bold.italic", size=16), #plot title aesthetics
                   plot.subtitle = ggplot2::element_text(hjust = 0.5, face = "bold", size = 12), #plot subtitle aesthetics
                   axis.title.x = ggplot2::element_text(size = 12, color= "black", face = "bold"), #x axis title aesthetics
                   axis.title.y = ggplot2::element_text(size = 12, color= "black", face = "bold"), #y axis title aesthetics
                   axis.text.x = ggplot2::element_text(angle = 0, hjust = 0.5, size = 12),
                   #legend aesthetics
                   legend.title = ggplot2::element_text(size= 14,
                                    color = "black",
                                    face = "bold"),
                   legend.title.align = 0.5,
                   legend.text = ggplot2::element_text(size = 10,
                                              color = "black",
                                              face = "bold"),
                   legend.text.align = 0)


raceCount <- dem.tab %>% count(race) %>%
  drop_na() %>%
  mutate(race = fct_reorder(race, desc(n))) %>%
  ggplot(aes(x = race, y = n, fill = race)) +
  geom_col() +
  labs(y = "Count",
       x = "Race",
       #caption = "Four subjects were removed because they ommitted their race.",
       title = "Subject Race Demographic",
       subtitle = "Original Cohort") +
  myGGTheme +
  scale_x_discrete(labels = c("White", "Black", "Asian", "Other")) +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_line(color = "lightblue1"))

ageCount <- dem.tab %>% select(age) %>% 
  ggplot(aes(x = age, fill = "red")) + 
  geom_histogram(binwidth = 2) +
  labs(y = "Count", 
       x = "Age (years)",
       title = "Subject Age Demographic",
       subtitle = "Original Cohort") +
  myGGTheme +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_line(color = "lightblue1"))


genderCount <- dem.tab %>% count(gender) %>%
  ggplot(aes(x = gender, y = n, fill = gender)) +
  geom_col() +
  labs(y = "Count",
       x = "Gender",
       title = "Subject Gender Demographic",
       subtitle = "Original Cohort") +
  myGGTheme +
  scale_x_discrete(labels = c("Female", "Male")) +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_line(color = "lightblue1"))
  
psychCondtionCount <- dem.tab %>% count(condition_description) %>%
  drop_na() %>%
  mutate(condition_description = fct_reorder(condition_description, desc(n))) %>%
  ggplot(aes(x = condition_description, y = n, fill = condition_description)) +
  geom_col() +
  labs(y = "Count",
       x = "Psychiatric Condition",
       title = "Subject Psychiatric Condition Demographic",
       subtitle = "Original Cohort") +
  myGGTheme +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_line(color = "lightblue1"))


alcoholCount <- dem.tab %>% count(alcohol_current) %>%
  drop_na() %>%
  ggplot(aes(x = alcohol_current, y = n, fill = alcohol_current)) +
  geom_bar(stat = "identity") +
  geom_col() +
  labs(y = "Count",
       x = "Current Alcohol Users",
       title = "Subject Alcohol Use Demographic",
       subtitle = "Original Cohort") +
  myGGTheme +
  scale_x_discrete(limits= "Yes", "No") +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_line(color = "lightblue1"))


drugsCount <- dem.tab %>% count(drugs_current) %>%
  drop_na() %>%
  ggplot(aes(x = drugs_current, y = n, fill = drugs_current)) +
  geom_bar(stat = "identity") +
  geom_col() +
  labs(y = "Count",
       x = "Current Marijuana Users",
       title = "Subject Marijuana Use Demographic",
       subtitle = "Original Cohort") +
  myGGTheme +
  scale_x_discrete(limits= "Yes", "No") +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_line(color = "lightblue1"))


smokeCount <- dem.tab %>% count(smoke_current) %>%
  drop_na() %>%
  ggplot(aes(x = smoke_current, y = n, fill = smoke_current)) +
  geom_bar(stat = "identity") +
  geom_col() +
  labs(y = "Count",
       x = "Current Smokers",
       title = "Subject Smoking Demographic",
       subtitle = "Original Cohort") +
  myGGTheme +
  scale_x_discrete(labels = c("Yes", "No")) +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "aliceblue"),
        plot.background = element_rect(fill = "aliceblue"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_line(color = "lightblue1"))


(raceCount | ageCount | genderCount)/ (alcoholCount | drugsCount | smokeCount)/ psychCondtionCount

``` 
